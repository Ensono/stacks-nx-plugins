# Pact Consumer Tests

Pact is an open-source testing framework that enables consumer-driven contract
testing between service providers and service consumers. Pactflow is a
cloud-based platform for implementing and managing contract testing using the
Pact framework.

This project is a basic set up for the consumer side of
[Bi-Directional Contract Testing](https://docs.pactflow.io/docs/bi-directional-contract-testing).
The examples in this project uses the
[PetStore OpenApi spec](https://github.com/OAI/OpenAPI-Specification/blob/main/examples/v3.0/petstore.yaml)
as an example.

# Adapting the project for your application

This generator partially sets up an example contract test project for your
applications context based on the prompts when running the generator.

However, there are changes required that are not handled by the generator due to
the requirement for a lot of application context. 
Users have two options for updating the project for their application:
- Using generative AI (I.e. GitHub Co-Pilot)
- Manual updates

## Generative AI
Within the code generated by this generated, there are a series of Todo comments highlighting prompts that have been proved to generate the required code in most scenarios. You will see these in the following format:

```javascript
// Todo: Generate relevant handlers for your project using GitHub Co-Pilot.
// Pre-requisites: Add the OpenApi spec, mockData.ts (once updated for your project) and handlers.ts as context in Co-Pilot
// Prompt: Given the `{openApiSpec}` OpenAPI spec, can you create me some handlers for each endpoint in the OpenApi spec as per the examples in `handlers.ts`. Mock data to be used in the handlers can be found in `mockData.ts`
```

`Pre-Requisites` highlight what files need to be added to the AI tool as context to help with generating accurate results.

`Prompt` gives a question/prompt that can be submitted to AI to generate relevant results. Some prompts have placeholders for values you will have to replace.

### Recommended prompt order
It is recommended that when using generative AI that you update files in the following order:
- `mockData.ts`
- `handlers.ts`
- `pactAdapter.ts`
- `example.test.ts`

This will ensure you have generated content in place for each subsequent question.

## Manual updates

### Create mock data

Within `./src/mock`, you will need to create Typescript classes representing
mock data for the providers API. There is an example in
`./src/mock/mockData.ts`.

### Updating handlers

In `./src/mock/handlers.ts`, you will need to add handlers for the provider API.
These are mocks handlers that intercept HTTP requests and provide your
predefined responses from mock data classes.

### Pact adapter

The file `./src/mock/pactAdapter.ts` should have automatically been updated
based on the consumerName and providerName prompts when running the generator.

You will need to update the array's of endpoints in both the `provider` object
and the `includeUrl` value:

```javascript
      providers: {
        ["<%= providerName %>"]: ["/pets", "/pets/1"],
      },
```

```javascript
    includeUrl: ["/pets", "/pets/1"],
```

### Consumer tests

You will need to create your consumer tests within `./src/test`. There is an
example test class `./src/test/example.test.ts`. The test hooks can be left
unchanged, but you will need to add tests for your API integration.

# Running tests locally

### Pre-requisites

Download and install [NodeJS](https://nodejs.org/en)

### Executing tests
\_(NB: This test will fail without the changes detailed in this ReadMe)\_\_

In a terminal, navigate to the root folder containing your new project (the
folder name will be the value of the `Name` variable supplied when running the
generator)

Install dependencies using `npm i`

Set up environment variable for `API_BASE_URL`

`export API_BASE_URL=${API_BASE_URL}` (e.g. http://localhost:3000)

These can also be set by creating a .env file and adding the following:
`API_BASE_URL=${API_BASE_URL}`

Execute tests using `npm test` 

# Running Pact tests in a pipeline

The value of Pact contract tests comes from publishing the contracts generated
and checking with PactFlow that you are safe to deploy your application without
breaking the contract with your provider(s). This section has some pipeline
snippets to help set this up.

**Note: These steps assume a [PactFlow](https://pactflow.io/pricing/) broker has
been set up for your teams to integrate with**

## Azure DevOps

First, you need to run your tests after the application build steps. This will
need to be run from within the folder containing your contract tests

```yaml
- script: npm ci
    displayName: "Install dependencies"

- script: npm run test
    displayName: "Run tests"
    env:
        API_BASE_URL: $(API_BASE_URL)
```

After your tests have run successfully and before your deployment stage, you
need to publish your Pact contracts to PactFlow. These steps contain variables
that will need to be replaced

```yaml
- script: |
      docker pull pactfoundation/pact-cli:latest
      displayName: "Pull Pact CLI Docker image"

- script: |
      docker run --rm \
          -w ${PWD} \
          -v ${PWD}:${PWD} \
          -e PACT_BROKER_BASE_URL=$(PACT_BROKER_BASE_URL) \
          -e PACT_BROKER_TOKEN=$(PACT_BROKER_TOKEN) \
          pactfoundation/pact-cli:latest \
          publish \
          $(PATH_TO_PACT_FILES) \
          --consumer-app-version $(appVersion) \
          --tag $(appVersion) $(Build.SourceBranchName) \
  displayName: 'Publish pact to Pactflow'
  env:
      PACTFLOW_TOKEN: $(PACT_BROKER_TOKEN)
```

In your Deploy stage, the first thing is to check if you are safe to deploy to
this environment using `can-i-deploy`

```yaml
- job: canideploy_test
    steps:
        - script: |
            docker run --rm \
                -e PACT_BROKER_BASE_URL=$(PACT_BROKER_BASE_URL) \
                -e PACT_BROKER_TOKEN=$(PACT_BROKER_TOKEN) \
                pactfoundation/pact-cli:latest \
                broker can-i-deploy \
                --pacticipant $(CONSUMER_NAME) \
                --version $(appVersion) \
                --to-environment test \
        displayName: "can-i-deploy Test"
```

When `can-i-deploy` succeeds, you progress your deployment steps.

After successful deployment, you will need to notify PactFlow of the deployment:

```yaml
- job: recordDeployment_test
  dependsOn: canideploy_test
  condition: succeeded()
  steps:
      - script: | # --version should be the version of your app/OpenAPI Spec
            docker run --rm \
                -e PACT_BROKER_BASE_URL=$(PACT_BROKER_BASE_URL) \
                -e PACT_BROKER_TOKEN=$(PACT_BROKER_TOKEN) \
                pactfoundation/pact-cli:latest \
                broker record-deployment \
                --pacticipant $(CONSUMER_NAME) \
                --version $(appVersion) \
                --environment test
        displayName: 'record-deployment Test'
```

## GitHub Actions

First, you need to run your tests after the application build steps. This will
need to be run from within the folder containing your contract tests

```yaml
- name: Install dependencies
  run: npm ci

- name: Run tests
  run: npm run test
  env:
      API_BASE_URL: ${{ vars.API_BASE_URL }}
```

After your tests have run successfully and before your deployment stage, you
need to publish your Pact contracts to PactFlow. These steps contain variables
that will need to be replaced

```yaml
- name: Publish Pact files
  uses: pactflow/actions/publish-pact-files@v2
  with:
      pactfiles: ./msw_generated_pacts
      version: ${{ env.APP_VERSION }}
      branch: ${{ env.BRANCH_NAME }}
      tag: ${{ env.APP_VERSION }} ${{ env.BRANCH_NAME }}
      broker_url: ${{ env.PACT_BROKER_BASE_URL }}
      token: ${{ secrets.PACT_BROKER_TOKEN }}
```

In your Deploy stage, the first thing is to check if you are safe to deploy to
this environment using `can-i-deploy`

```yaml
steps:
    - name: can-i-deploy-test
      uses: pactflow/actions/can-i-deploy@v2
      with:
          broker_url: ${{ env.PACT_BROKER_BASE_URL }}
          token: ${{ secrets.PACT_BROKER_TOKEN }}
          application_name: ${{ env.PACTICIPANT_NAME }}
          version: ${{ env.APP_VERSION }} # This should be the version of your app/OpenAPI Spec
          to_environment: 'test' # This environment needs to be configured in the PactFlow broker.
```

When `can-i-deploy` succeeds, you progress your deployment steps.

After successful deployment, you will need to notify PactFlow of the deployment:

```yaml
- name: record-deployment-test
  uses: pactflow/actions/record-deployment@v2
  with:
      version: ${{ env.APP_VERSION }} # This should be the version of your app/OpenAPI Spec
      environment: 'test'
      application_name: ${{ env.PACTICIPANT_NAME }}
      broker_url: ${{ env.PACT_BROKER_BASE_URL }}
      token: ${{ secrets.PACT_BROKER_TOKEN }}
```
