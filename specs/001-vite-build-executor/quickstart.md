# Quickstart: Vite Build Executor with Centralised Dependency Versions

## Prerequisites

- Node.js 22.16.0 (`engines` field in package.json)
- pnpm 10.7.0+
- Repository cloned on branch `001-vite-build-executor`

## How It Works

### Adding a New Generator Dependency

1. Add the package and version to `tools/versions.ts`:

    ```typescript
    export const generatorDependencyVersions: Record<string, string> = {
        // ...existing entries
        'my-new-package': '^2.0.0',
    };
    ```

2. Add the same package to root `package.json` devDependencies:

    ```json
    "devDependencies": {
      "my-new-package": "^2.0.0"
    }
    ```

3. Run `pnpm install --frozen-lockfile` (or update the lockfile if needed).

4. Reference the version in your generator source code:

    ```typescript
    addDependenciesToPackageJson(
        tree,
        {
            'my-new-package': __versions__.my_new_package,
        },
        {},
    );
    ```

5. Build the package:

    ```bash
    pnpm exec nx build <package-name>
    ```

6. The compiled output will contain the literal string `"^2.0.0"` — no runtime
   resolution needed.

### How the Transform Works

The `__versions__` namespace uses transformed package names:

| npm package              | Global reference                      |
| ------------------------ | ------------------------------------- |
| `axios`                  | `__versions__.axios`                  |
| `@tanstack/react-query`  | `__versions__.tanstack$react_query`   |
| `eslint-plugin-security` | `__versions__.eslint_plugin_security` |
| `@storybook/nextjs`      | `__versions__.storybook$nextjs`       |

**Rules**: Strip `@`, replace `/` → `$`, replace `-` and `.` → `_`

### Updating an Existing Version

1. Update the version in root `package.json` devDependencies (this is the
   authoritative source)
2. Update the matching entry in `tools/versions.ts` to match
3. Run `pnpm install`
4. Rebuild affected packages — the new version propagates automatically

### Building

```bash
# Single package
pnpm exec nx build next

# All packages
pnpm exec nx run-many -t build --all --parallel 8

# Affected packages only
pnpm exec nx affected -t build
```

### Verifying Build Output

After building, check that version constants are inlined:

```bash
grep -r '__versions__' packages/next/dist/
# Should return NO results — all replaced with literal strings

grep -r '"1.7.7"\|"5.90.20"' packages/next/dist/
# Should find the literal version strings in the compiled output
```

## Development Notes

- Tests run via `vitest.config.mts` (separate from build config)
- The `vite.config.ts` files are for building only
- TypeScript declarations are generated by `vite-plugin-dts`
- Assets (JSON, EJS, markdown) are copied by `nxCopyAssetsPlugin`
